"use strict";angular.module("csgoApp",["ngCookies","ngResource","ngSanitize","btford.socket-io","ui.router","ui.bootstrap"]).config(["$stateProvider","$urlRouterProvider","$locationProvider","$httpProvider",function(a,b,c,d){b.otherwise("/"),c.html5Mode(!0),d.interceptors.push("authInterceptor")}]).factory("authInterceptor",["$rootScope","$q","$cookieStore","$location",function(a,b,c,d){return{request:function(a){return a.headers=a.headers||{},c.get("token")&&(a.headers.Authorization="Bearer "+c.get("token")),a},responseError:function(a){return 401===a.status?(d.path("/login"),c.remove("token"),b.reject(a)):b.reject(a)}}}]).run(["$rootScope","$location","Auth",function(a,b,c){a.$on("$stateChangeStart",function(a,d){c.isLoggedInAsync(function(a){d.authenticate&&!a&&b.path("/login"),d.authenticate&&d.isAdmin&&!c.isAdmin()&&b.path("/login")})})}]),angular.module("csgoApp").config(["$stateProvider",function(a){a.state("login",{url:"/login",templateUrl:"app/account/login/login.html",controller:"LoginCtrl"}).state("signup",{url:"/signup",templateUrl:"app/account/signup/signup.html",controller:"SignupCtrl"}).state("deposits",{url:"/account/deposits",templateUrl:"app/account/deposits/deposits.html",controller:"DepositsCtrl",authenticate:!0}).state("settings",{url:"/account/settings",templateUrl:"app/account/settings/settings.html",controller:"SettingsCtrl",authenticate:!0})}]),angular.module("csgoApp").controller("DepositsCtrl",["$scope","Trade","$modal",function(a,b,c){a.deposits=b.history(function(b){for(var c=0;c<b.length;c++){a.deposits[c].totalPrice=0;for(var d=0;d<b[c].items.length;d++)a.deposits[c].totalPrice+=b[c].items[d].price}})}]),angular.module("csgoApp").controller("LoginCtrl",["$scope","Auth","$location","$window",function(a,b,c,d){a.user={},a.errors={},a.login=function(d){a.submitted=!0,d.$valid&&b.login({email:a.user.email,password:a.user.password}).then(function(){c.path("/")})["catch"](function(b){a.errors.other=b.message})},a.loginOauth=function(a){d.location.href="/auth/"+a}}]),angular.module("csgoApp").controller("SettingsCtrl",["$scope","User","Auth",function(a,b,c){a.errors={},a.currentUser=c.getCurrentUser(),a.update=function(b){a.submitted=!0,console.log(b)}}]),angular.module("csgoApp").controller("SignupCtrl",["$scope","Auth","$location","$window",function(a,b,c,d){a.user={},a.errors={},a.register=function(d){a.submitted=!0,d.$valid&&b.createUser({name:a.user.name,email:a.user.email,password:a.user.password}).then(function(){c.path("/")})["catch"](function(b){b=b.data,a.errors={},angular.forEach(b.errors,function(b,c){d[c].$setValidity("mongoose",!1),a.errors[c]=b.message})})},a.loginOauth=function(a){d.location.href="/auth/"+a}}]),angular.module("csgoApp").controller("AdminCtrl",["$scope","$http","Auth","Lottery",function(a,b,c,d){a.lotteries=d.index()}]),angular.module("csgoApp").config(["$stateProvider",function(a){a.state("admin",{url:"/admin",templateUrl:"app/admin/admin.html",controller:"AdminCtrl",authenticate:!0,isAdmin:!0}).state("admin_lotteries_index",{url:"/admin/lotteries",templateUrl:"app/admin/lotteries/lotteries.html",controller:"AdminLotteryCtrl",authenticate:!0,isAdmin:!0}).state("admin_lottery_show",{url:"/admin/lotteries/{lotteryId}",templateUrl:"app/admin/lotteries/lottery_show.html",controller:"AdminLotteryCtrl",authenticate:!0,isAdmin:!0})}]),angular.module("csgoApp").controller("AdminLotteryCtrl",["$scope","$http","Auth","Lottery","$stateParams",function(a,b,c,d,e){a.lotteries=d.index(),e.lotteryId&&(a.lottery=d.show({id:e.lotteryId})),a.retrieveItems=function(a){var b=[];if("undefined"==typeof a||"undefined"==typeof a.trades)return b;for(var c=0;c<a.trades.length;c++)for(var d=0;d<a.trades[c].items.length;d++)b.push(a.trades[c].items[d]);return b}}]),angular.module("csgoApp").directive("knob",function(){function a(a,b,c){function d(){b.empty();var a=$('<input type="text">'),d=$("<span></span>"),e=c.min?parseInt(c.min):0,f=c.max?parseInt(c.max):0,g=c.value?parseInt(c.value):"",h="true"==c.readonly?!0:!1,i=c.price?parseInt(c.price):0,j=c.color?c.color:"#00A65A",k=c.dangerLowerThen,l=c.warnLowerThen;k&&k>g?j="#F56954":l&&l>g&&(j="#F39C12"),b.append(a);var m={value:0,min:e,max:f>g?f:g,dynamicDraw:!0,fgColor:j,readOnly:h,thickness:.2,width:250,height:250,rtl:"rtl"==c.dir?!0:!1,draw:function(){$(this.i).html(this.cv),$(this.i).css("margin-top","65px"),a.after(d),d.html("&#36;"+i),d.css({width:a.css("width"),color:a.css("color"),"margin-top":parseInt(a.css("margin-top").replace("px",""))+80+"px","margin-left":a.css("margin-left"),"font-size":"22pt","text-align":"center",position:"absolute"}),this.cursorExt=.3;var b,c=this.arc(this.cv),e=1;return this.g.lineWidth=this.lineWidth,this.o.displayPrevious&&(b=this.arc(this.v),this.g.beginPath(),this.g.strokeStyle=this.pColor,this.g.arc(this.xy,this.xy,this.radius-this.lineWidth,b.s,b.e,b.d),this.g.stroke()),this.g.beginPath(),this.g.strokeStyle=e?this.o.fgColor:this.fgColor,this.g.arc(this.xy,this.xy,this.radius-this.lineWidth,c.s,c.e,c.d),this.g.stroke(),this.g.lineWidth=2,this.g.beginPath(),this.g.strokeStyle=this.o.fgColor,this.g.arc(this.xy,this.xy,this.radius-this.lineWidth+1+1.7*this.lineWidth/3,0,2*Math.PI,!1),this.g.stroke(),!1}};a.knob(m),a.animate({value:100},{duration:1e3,easing:"swing",progress:function(){$(this).val(Math.round(this.value/100*g)).trigger("change")}})}a.$watch(function(){return[c.value,c.max,c.min,c.readonly]},d,!0)}return{priority:99,restrict:"A",link:a}}),angular.module("csgoApp").controller("HowToCtrl",["$scope","$http",function(a,b){}]),angular.module("csgoApp").config(["$stateProvider",function(a){a.state("howto",{url:"/howto",templateUrl:"app/howto/howto.html",controller:"HowToCtrl"})}]),angular.module("csgoApp").controller("MainCtrl",["$scope","$http","Lottery","Auth","Chat","socket","$cookies",function(a,b,c,d,e,f,g){var h="alert_deposited",i="";a.bot={steamid:"166216092",token:"xN4pQeXz"},a.deposited={showAlert:"undefined"!=typeof g.get(h),message:"undefined"!=typeof g.get(h)?g.get(i):""},a.isLoggedIn=d.isLoggedIn,a.knob={contributes:0,goal:50},a.lotteries=c.index(function(b){a.handleLotteries(b)}),a.chats=e.index(),a.chat={},a.sendChat=function(){a.chat.message&&(e.create(a.chat),alert("message sent!"))},a.hideAlert=function(){g.remove(h),a.deposited.showAlert=!1},f.syncUpdates("lottery",[],function(b,c,e){var f=_.find(a.lotteries,{_id:c._id}),i=a.lotteries.indexOf(f);if(f){if(c.trades.length>0&&c.trades[0].issuedBy._id==d.getCurrentUser()._id){var j="You have deposited "+c.trades[c.trades.length-1].items.length+" skins successfully!";a.deposited.message=j,g.put(h,j),a.deposited.showAlert=!0}a.lotteries.splice(i,1,c)}else a.lotteries.unshift(c);a.handleLotteries(e)}),f.syncUpdates("chat",a.chats),a.retrieveItems=function(a){var b=[];if("undefined"==typeof a||"undefined"==typeof a.trades)return b;for(var c=0;c<a.trades.length;c++)for(var d=0;d<a.trades[c].items.length;d++)b.push(a.trades[c].items[d]);return b},a.handleLotteries=function(b){for(var c=0;c<b.length;c++){for(var d=0,e=0,f=0;f<b[c].trades.length;f++){a.lotteries[c].trades[f].total_price=0;for(var g=0;g<b[c].trades[f].items.length;g++)d++,a.lotteries[c].trades[f].total_price+=b[c].trades[f].items[g].price;e+=a.lotteries[c].trades[f].total_price}b[c].active&&(a.lotteries[c].total_price=e,a.lotteries[c].total_items=d)}},a.$on("$destroy",function(){f.unsyncUpdates("trade"),f.unsyncUpdates("chat")})}]),angular.module("csgoApp").config(["$stateProvider",function(a){a.state("main",{url:"/",templateUrl:"app/main/main.html",controller:"MainCtrl"})}]),angular.module("csgoApp").factory("Chat",["$resource",function(a){return a("api/chats/:method:id",{id:"@_id"},{index:{method:"GET",isArray:!0},create:{method:"POST",params:{method:"create"}}})}]),angular.module("csgoApp").factory("Lottery",["$resource",function(a){return a("api/lotteries/:method:id",{id:"@_id"},{show:{method:"GET",isArray:!1},index:{method:"GET",isArray:!0},active:{method:"GET",params:{method:"active"},isArray:!1}})}]),angular.module("csgoApp").factory("Trade",["$resource",function(a){return a("api/trades/:id/:controller",{id:"@_id"},{history:{method:"GET",params:{controller:"history"},isArray:!0}})}]),angular.module("csgoApp").factory("Auth",["$location","$rootScope","$http","User","$cookieStore","$q",function(a,b,c,d,e,f){var g={};return e.get("token")&&(g=d.get(),console.log(g)),{login:function(a,b){var h=b||angular.noop,i=f.defer();return c.post("/auth/local",{email:a.email,password:a.password}).success(function(a){return e.put("token",a.token),g=d.get(),i.resolve(a),h()}).error(function(a){return this.logout(),i.reject(a),h(a)}.bind(this)),i.promise},logout:function(){e.remove("token"),g={}},createUser:function(a,b){var c=b||angular.noop;return d.save(a,function(b){return e.put("token",b.token),g=d.get(),c(a)},function(a){return this.logout(),c(a)}.bind(this)).$promise},changePassword:function(a,b,c){var e=c||angular.noop;return d.changePassword({id:g._id},{oldPassword:a,newPassword:b},function(a){return e(a)},function(a){return e(a)}).$promise},getCurrentUser:function(){return g},isLoggedIn:function(){return g.hasOwnProperty("role")},isLoggedInAsync:function(a){g.hasOwnProperty("$promise")?g.$promise.then(function(){a(!0)})["catch"](function(){a(!1)}):a(g.hasOwnProperty("role")?!0:!1)},isAdmin:function(){return"admin"===g.role},getToken:function(){return e.get("token")}}}]),angular.module("csgoApp").factory("User",["$resource",function(a){return a("/api/users/:id/:controller",{id:"@_id"},{changePassword:{method:"PUT",params:{controller:"password"}},get:{method:"GET",params:{id:"me"}}})}]),angular.module("csgoApp").controller("HeaderCtrl",["$scope","$location","Auth",function(a,b,c){a.menu=[{title:"Home",link:"/"}],a.isCollapsed=!0,a.isLoggedIn=c.isLoggedIn,a.isAdmin=c.isAdmin,a.getCurrentUser=c.getCurrentUser,a.logout=function(){c.logout(),b.path("/login")},a.isActive=function(a){return a===b.path()}}]),angular.module("csgoApp").factory("Modal",["$rootScope","$modal",function(a,b){function c(c,d){var e=a.$new();return c=c||{},d=d||"modal-default",angular.extend(e,c),b.open({templateUrl:"components/modal/modal.html",windowClass:d,scope:e})}return{confirm:{"delete":function(a){return a=a||angular.noop,function(){var b,d=Array.prototype.slice.call(arguments),e=d.shift();b=c({modal:{dismissable:!0,title:"Confirm Delete",html:"<p>Are you sure you want to delete <strong>"+e+"</strong> ?</p>",buttons:[{classes:"btn-danger",text:"Delete",click:function(a){b.close(a)}},{classes:"btn-default",text:"Cancel",click:function(a){b.dismiss(a)}}]}},"modal-danger"),b.result.then(function(b){a.apply(b,d)})}}}}}]),angular.module("csgoApp").directive("mongooseError",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){b.on("keydown",function(){return d.$setValidity("mongoose",!0)})}}}),angular.module("csgoApp").factory("socket",["socketFactory",function(a){var b=io("",{path:"/socket.io-client"}),c=a({ioSocket:b});return{socket:c,syncUpdates:function(a,b,d){d=d||angular.noop,c.on(a+":save",function(a){var c=_.find(b,{_id:a._id}),e=b.indexOf(c),f="created";c?(b.splice(e,1,a),f="updated"):b.push(a),d(f,a,b)}),c.on(a+":remove",function(a){var c="deleted";_.remove(b,{_id:a._id}),d(c,a,b)})},unsyncUpdates:function(a){c.removeAllListeners(a+":save"),c.removeAllListeners(a+":remove")}}}]),angular.module("csgoApp").run(["$templateCache",function(a){a.put("app/account/deposits/deposits.html",'<div class=page><div class=page-header><h1>Deposits</h1></div><div class="page-content container"><ul id=deposits class=boxes><li ng-repeat="deposit in deposits"><div class=box-info><span class=deposit-total-price>${{ deposit.totalPrice }}</span> <span class=deposit-date>{{ deposit.issuedOn | date:\'fullDate\'}}</span></div><div class=deposit-items><ul class=items><li ng-repeat="item in deposit.items"><img src=# ng-src="https://steamcommunity-a.akamaihd.net/economy/image/class/730/{{ item.item.classId }}/200fx200f" ng-alt="{{ item.item.market_hash_name }}"></li></ul></div></li></ul></div></div>'),a.put("app/account/login/login.html",'<div ng-include="\'components/navbar/navbar.html\'"></div><div class=container><div class=row><div class=col-sm-12><h1>Login</h1><p>Accounts are reset on server restart from <code>server/config/seed.js</code>. Default account is <code>test@test.com</code> / <code>test</code></p><p>Admin account is <code>admin@admin.com</code> / <code>admin</code></p></div><div class=col-sm-12><form class=form name=form ng-submit=login(form) novalidate><div class=form-group><label>Email</label><input type=email name=email class=form-control ng-model=user.email required></div><div class=form-group><label>Password</label><input type=password name=password class=form-control ng-model=user.password required></div><div class="form-group has-error"><p class=help-block ng-show="form.email.$error.required && form.password.$error.required && submitted">Please enter your email and password.</p><p class=help-block ng-show="form.email.$error.email && submitted">Please enter a valid email.</p><p class=help-block>{{ errors.other }}</p></div><div><button class="btn btn-inverse btn-lg btn-login" type=submit>Login</button> <a class="btn btn-default btn-lg btn-register" href=/signup>Register</a></div><hr><div><a class="btn btn-twitter" href="" ng-click="loginOauth(\'twitter\')"><i class="fa fa-twitter"></i> Connect with Twitter</a></div></form></div></div><hr></div>'),a.put("app/account/settings/settings.html",'<div class=page><div class=page-header><h1>Settings</h1></div><div class="page-content container"><h2>Trade URL</h2><p>Your trade URL is available at the following link: <a href=# ng-href="http://steamcommunity.com/profiles/{{ currentUser.steam.steamid }}/tradeoffers/privacy#trade_offer_access_url">http://steamcommunity.com/profiles/{{ currentUser.steam.steamid }}/tradeoffers/privacy#trade_offer_access_url</a></p><input id=trade-url placeholder="Your trade URL" ng-model="setting.tradeurl"><p>Please set both profile and backpack privacy to public and have enough space in the inventory.</p><button id=settings-save class=button-blue ng-click=update(setting)>Save</button></div></div>'),a.put("app/account/signup/signup.html",'<div ng-include="\'components/navbar/navbar.html\'"></div><div class=container><div class=row><div class=col-sm-12><h1>Sign up</h1></div><div class=col-sm-12><form class=form name=form ng-submit=register(form) novalidate><div class=form-group ng-class="{ \'has-success\': form.name.$valid && submitted,\n                                            \'has-error\': form.name.$invalid && submitted }"><label>Name</label><input name=name class=form-control ng-model=user.name required><p class=help-block ng-show="form.name.$error.required && submitted">A name is required</p></div><div class=form-group ng-class="{ \'has-success\': form.email.$valid && submitted,\n                                            \'has-error\': form.email.$invalid && submitted }"><label>Email</label><input type=email name=email class=form-control ng-model=user.email required mongoose-error><p class=help-block ng-show="form.email.$error.email && submitted">Doesn\'t look like a valid email.</p><p class=help-block ng-show="form.email.$error.required && submitted">What\'s your email address?</p><p class=help-block ng-show=form.email.$error.mongoose>{{ errors.email }}</p></div><div class=form-group ng-class="{ \'has-success\': form.password.$valid && submitted,\n                                            \'has-error\': form.password.$invalid && submitted }"><label>Password</label><input type=password name=password class=form-control ng-model=user.password ng-minlength=3 required mongoose-error><p class=help-block ng-show="(form.password.$error.minlength || form.password.$error.required) && submitted">Password must be at least 3 characters.</p><p class=help-block ng-show=form.password.$error.mongoose>{{ errors.password }}</p></div><div><button class="btn btn-inverse btn-lg btn-login" type=submit>Sign up</button> <a class="btn btn-default btn-lg btn-register" href=/login>Login</a></div><hr><div><a class="btn btn-twitter" href="" ng-click="loginOauth(\'twitter\')"><i class="fa fa-twitter"></i> Connect with Twitter</a></div></form></div></div><hr></div>'),a.put("app/admin/admin.html",'<div class=page><div class=page-header><h1>Admin</h1></div><div class="page-content container"><h2>Lotteries</h2><a href=/admin/lotteries>Manage Lotteries</a></div></div>'),a.put("app/admin/lotteries/lotteries.html",'<div class=page><div class=page-header><h1>Admin</h1></div><div class="page-content container"><h2>Manage lotteries</h2><ul class=boxes><a ng-href="/admin/lotteries/{{ lottery._id }}" ng-repeat="lottery in lotteries" ng-if=!lottery.active><li ng-class="[\'box\', {\'box-error\': lottery.errorRewarding}]"><div class=box-info>{{ lottery.endedOn | date:\'fullDate\' }}<br>{{ lottery.errorMessage }}</div></li></a></ul></div></div>'),a.put("app/admin/lotteries/lottery_show.html",'<div class=page><div class=page-header><h1>Lottery details</h1></div><div class="page-content container"><table class=table><tr><th style=width:12%>Winner:</th><td>{{ lottery.winner.displayName }}</td></tr><tr><th>Win chance:</th><td>{{ lottery.winChance }}%</td></tr><tr><th>Started on:</th><td>{{ lottery.startedOn | date:\'fullDate\'}}</td></tr><tr><th>Ended on:</th><td>{{ lottery.endedOn | date:\'fullDate\'}}</td></tr><tr><th>Trades</th><td>{{ lottery.trades.length }}</td></tr><tr><th>Items:</th><td><ul><li ng-repeat="item in retrieveItems(lottery)">{{ item.item.market_hash_name }}</li></ul></td></tr></table><div><a class="button button-blue" href=/admin/lotteries>Back to dashboard</a></div></div></div>'),a.put("app/howto/howto.html","HOW TO"),a.put("app/main/main.html",'<div id=left><ul class="pool-items current"><li ng-repeat="item in retrieveItems(lotteries[0])"><img src=# ng-src="https://steamcommunity-a.akamaihd.net/economy/image/class/730/{{ item.item.classId }}/200fx200f" ng-alt="{{ item.item.market_hash_name }}"><div class=item-info><span class=item-name>{{ item.item.market_hash_name }}</span> <span class=item-price>{{ item.price }}$</span></div></li></ul></div><div id=mid><div ng-show=deposited.showAlert ng-click=hideAlert() class="alert alert-success">{{ deposited.message }}</div><div class=pool ng-repeat="lottery in lotteries"><!-- show winner --><div class=pool-winner ng-show=!lottery.active>{{ lottery.winner.displayName }} won the jackpot with a {{ lottery.winChance }}% chance</div><!-- show lottery knob --><div class=pool-overview ng-show=lottery.active><div style=text-align:center><div knob value="{{ lottery.total_items }}" min=0 max=50 color=#54BEFF price="{{ lottery.total_price }}" readonly><a href=# ng-href="https://steamcommunity.com/tradeoffer/new/?partner={{ bot.steamid }}&token={{ bot.token }}" target=_blank ng-show=isLoggedIn() class=button-blue>Deposit items</a></div></div><!-- show deposits --><ul class=deposits><li class=deposit ng-repeat="deposit in lottery.trades"><img src="{{ deposit.issuedBy.steam.avatarmedium }}" alt="avatar of {{ deposit.issuedBy.displayName }}" class="avatar"> <span class=username>{{ deposit.issuedBy.displayName }}</span> deposited <span class=quantity>{{ deposit.items.length }}</span> item worth <span class=price>${{ deposit.total_price }}</span></li><li ng-show="lottery.trades.length == 0">The jackpot doesn\'t contain any items yet.</li></ul><div class=pool-info><p class=pool-startedon><span ng-if=lottery.active>Started on: {{ lottery.startedOn | date:\'fullDate\' }}</span> <span ng-if=!lottery.active>Ended on: {{ lottery.endedOn | date:\'fullDate\' }}</span></p></div></div></div><div id=right><div id=chatbox><ul id=chat-messages><li ng-repeat="chat in chats"><p class=user><img ng-src="{{ chat._author.steam.avatar }}"> <span class=username>{{ chat._author.displayName }}</span></p><p class=message>{{ chat.message }}</p></li></ul><form id=chat-box ng-submit=sendChat()><input id=chat_text name=_chat_text ng-model="chat.message"> <button type=submit>Send</button></form></div></div>'),a.put("components/header/header.html",'<div class=logo><span id=logo>CSGOJackpot</span></div><nav><ul><li ng-show=isAdmin() ng-class="{active: isActive(\'/admin\')}"><a href=/admin>Admin</a></li><li><a href="/" target=_self>Home</a></li><li><a ng-href=/howto target=_self>How to</a></li><li><a href=/about target=_self>About</a></li><li><a href=/support target=_self>Support</a></li><li ng-show=!isLoggedIn()><a href=/auth/steam target=_self>Login</a></li><li ng-show=isLoggedIn()><a href=# ng-click=logout()><img ng-src="{{ getCurrentUser().steam.avatar }}" src=# class=profile-image alt="Profile image of {{ getCurrentUser().displayName }}"> Logout</a></li></ul></nav>'),a.put("components/modal/modal.html",'<div class=modal-header><button ng-if=modal.dismissable type=button ng-click=$dismiss() class=close>&times;</button><h4 ng-if=modal.title ng-bind=modal.title class=modal-title></h4></div><div class=modal-body><p ng-if=modal.text ng-bind=modal.text></p><div ng-if=modal.html ng-bind-html=modal.html></div></div><div class=modal-footer><button ng-repeat="button in modal.buttons" ng-class=button.classes ng-click=button.click($event) ng-bind=button.text class=btn></button></div>')}]);